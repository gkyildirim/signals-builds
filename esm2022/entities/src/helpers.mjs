import { DidMutate, } from './models';
const defaultSelectId = (entity) => entity.id;
export function getEntityIdSelector(config) {
    return config?.selectId ?? defaultSelectId;
}
export function getEntityStateKeys(config) {
    const collection = config?.collection;
    const entityMapKey = collection === undefined ? 'entityMap' : `${collection}EntityMap`;
    const idsKey = collection === undefined ? 'ids' : `${collection}Ids`;
    const entitiesKey = collection === undefined ? 'entities' : `${collection}Entities`;
    return { entityMapKey, idsKey, entitiesKey };
}
export function cloneEntityState(state, stateKeys) {
    return {
        entityMap: { ...state[stateKeys.entityMapKey] },
        ids: [...state[stateKeys.idsKey]],
    };
}
export function getEntityUpdaterResult(state, stateKeys, didMutate) {
    switch (didMutate) {
        case DidMutate.Both: {
            return {
                [stateKeys.entityMapKey]: state.entityMap,
                [stateKeys.idsKey]: state.ids,
            };
        }
        case DidMutate.Entities: {
            return { [stateKeys.entityMapKey]: state.entityMap };
        }
        default: {
            return {};
        }
    }
}
export function addEntityMutably(state, entity, selectId) {
    const id = selectId(entity);
    if (state.entityMap[id]) {
        return DidMutate.None;
    }
    state.entityMap[id] = entity;
    state.ids.push(id);
    return DidMutate.Both;
}
export function addEntitiesMutably(state, entities, selectId) {
    let didMutate = DidMutate.None;
    for (const entity of entities) {
        const result = addEntityMutably(state, entity, selectId);
        if (result === DidMutate.Both) {
            didMutate = result;
        }
    }
    return didMutate;
}
export function setEntityMutably(state, entity, selectId) {
    const id = selectId(entity);
    if (state.entityMap[id]) {
        state.entityMap[id] = entity;
        return DidMutate.Entities;
    }
    state.entityMap[id] = entity;
    state.ids.push(id);
    return DidMutate.Both;
}
export function setEntitiesMutably(state, entities, selectId) {
    let didMutate = DidMutate.None;
    for (const entity of entities) {
        const result = setEntityMutably(state, entity, selectId);
        if (didMutate === DidMutate.Both) {
            continue;
        }
        didMutate = result;
    }
    return didMutate;
}
export function removeEntitiesMutably(state, idsOrPredicate) {
    const ids = Array.isArray(idsOrPredicate)
        ? idsOrPredicate
        : state.ids.filter((id) => idsOrPredicate(state.entityMap[id]));
    let didMutate = DidMutate.None;
    for (const id of ids) {
        if (state.entityMap[id]) {
            delete state.entityMap[id];
            didMutate = DidMutate.Both;
        }
    }
    if (didMutate === DidMutate.Both) {
        state.ids = state.ids.filter((id) => id in state.entityMap);
    }
    return didMutate;
}
export function updateEntitiesMutably(state, idsOrPredicate, changes, selectId) {
    const ids = Array.isArray(idsOrPredicate)
        ? idsOrPredicate
        : state.ids.filter((id) => idsOrPredicate(state.entityMap[id]));
    let newIds = undefined;
    let didMutate = DidMutate.None;
    for (const id of ids) {
        const entity = state.entityMap[id];
        if (entity) {
            const changesRecord = typeof changes === 'function' ? changes(entity) : changes;
            state.entityMap[id] = { ...entity, ...changesRecord };
            didMutate = DidMutate.Entities;
            const newId = selectId(state.entityMap[id]);
            if (newId !== id) {
                state.entityMap[newId] = state.entityMap[id];
                delete state.entityMap[id];
                newIds = newIds || {};
                newIds[id] = newId;
            }
        }
    }
    if (newIds) {
        state.ids = state.ids.map((id) => newIds[id] ?? id);
        didMutate = DidMutate.Both;
    }
    if (ngDevMode && state.ids.length !== Object.keys(state.entityMap).length) {
        console.warn('@ngrx/signals/entities: Entities with IDs:', ids, 'are not updated correctly.', 'Make sure to apply valid changes when using `updateEntity`,', '`updateEntities`, and `updateAllEntities` updaters.');
    }
    return didMutate;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVscGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL21vZHVsZXMvc2lnbmFscy9lbnRpdGllcy9zcmMvaGVscGVycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxHQU1WLE1BQU0sVUFBVSxDQUFDO0FBR2xCLE1BQU0sZUFBZSxHQUFxQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztBQUVoRixNQUFNLFVBQVUsbUJBQW1CLENBQUMsTUFFbkM7SUFDQyxPQUFPLE1BQU0sRUFBRSxRQUFRLElBQUksZUFBZSxDQUFDO0FBQzdDLENBQUM7QUFFRCxNQUFNLFVBQVUsa0JBQWtCLENBQUMsTUFBZ0M7SUFLakUsTUFBTSxVQUFVLEdBQUcsTUFBTSxFQUFFLFVBQVUsQ0FBQztJQUN0QyxNQUFNLFlBQVksR0FDaEIsVUFBVSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxHQUFHLFVBQVUsV0FBVyxDQUFDO0lBQ3BFLE1BQU0sTUFBTSxHQUFHLFVBQVUsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxVQUFVLEtBQUssQ0FBQztJQUNyRSxNQUFNLFdBQVcsR0FDZixVQUFVLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsVUFBVSxVQUFVLENBQUM7SUFFbEUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLENBQUM7QUFDL0MsQ0FBQztBQUVELE1BQU0sVUFBVSxnQkFBZ0IsQ0FDOUIsS0FBMEIsRUFDMUIsU0FHQztJQUVELE9BQU87UUFDTCxTQUFTLEVBQUUsRUFBRSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLEVBQUU7UUFDL0MsR0FBRyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsU0FB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O0lBRUQsSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUNYLEtBQUssQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNwRCxTQUFTLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQztJQUM3QixDQUFDO0lBRUQsSUFBSSxTQUFTLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEtBQUssTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDMUUsT0FBTyxDQUFDLElBQUksQ0FDViw0Q0FBNEMsRUFDNUMsR0FBRyxFQUNILDRCQUE0QixFQUM1Qiw2REFBNkQsRUFDN0QscURBQXFELENBQ3RELENBQUM7SUFDSixDQUFDO0lBRUQsT0FBTyxTQUFTLENBQUM7QUFDbkIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERpZE11dGF0ZSxcbiAgRW50aXR5Q2hhbmdlcyxcbiAgRW50aXR5SWQsXG4gIEVudGl0eVByZWRpY2F0ZSxcbiAgRW50aXR5U3RhdGUsXG4gIFNlbGVjdEVudGl0eUlkLFxufSBmcm9tICcuL21vZGVscyc7XG5cbmRlY2xhcmUgY29uc3QgbmdEZXZNb2RlOiB1bmtub3duO1xuY29uc3QgZGVmYXVsdFNlbGVjdElkOiBTZWxlY3RFbnRpdHlJZDx7IGlkOiBFbnRpdHlJZCB9PiA9IChlbnRpdHkpID0+IGVudGl0eS5pZDtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldEVudGl0eUlkU2VsZWN0b3IoY29uZmlnPzoge1xuICBzZWxlY3RJZD86IFNlbGVjdEVudGl0eUlkPGFueT47XG59KTogU2VsZWN0RW50aXR5SWQ8YW55PiB7XG4gIHJldHVybiBjb25maWc/LnNlbGVjdElkID8/IGRlZmF1bHRTZWxlY3RJZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEVudGl0eVN0YXRlS2V5cyhjb25maWc/OiB7IGNvbGxlY3Rpb24/OiBzdHJpbmcgfSk6IHtcbiAgZW50aXR5TWFwS2V5OiBzdHJpbmc7XG4gIGlkc0tleTogc3RyaW5nO1xuICBlbnRpdGllc0tleTogc3RyaW5nO1xufSB7XG4gIGNvbnN0IGNvbGxlY3Rpb24gPSBjb25maWc/LmNvbGxlY3Rpb247XG4gIGNvbnN0IGVudGl0eU1hcEtleSA9XG4gICAgY29sbGVjdGlvbiA9PT0gdW5kZWZpbmVkID8gJ2VudGl0eU1hcCcgOiBgJHtjb2xsZWN0aW9ufUVudGl0eU1hcGA7XG4gIGNvbnN0IGlkc0tleSA9IGNvbGxlY3Rpb24gPT09IHVuZGVmaW5lZCA/ICdpZHMnIDogYCR7Y29sbGVjdGlvbn1JZHNgO1xuICBjb25zdCBlbnRpdGllc0tleSA9XG4gICAgY29sbGVjdGlvbiA9PT0gdW5kZWZpbmVkID8gJ2VudGl0aWVzJyA6IGAke2NvbGxlY3Rpb259RW50aXRpZXNgO1xuXG4gIHJldHVybiB7IGVudGl0eU1hcEtleSwgaWRzS2V5LCBlbnRpdGllc0tleSB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2xvbmVFbnRpdHlTdGF0ZShcbiAgc3RhdGU6IFJlY29yZDxzdHJpbmcsIGFueT4sXG4gIHN0YXRlS2V5czoge1xuICAgIGVudGl0eU1hcEtleTogc3RyaW5nO1xuICAgIGlkc0tleTogc3RyaW5nO1xuICB9XG4pOiBFbnRpdHlTdGF0ZTxhbnk+IHtcbiAgcmV0dXJuIHtcbiAgICBlbnRpdHlNYXA6IHsgLi4uc3RhdGVbc3RhdGVLZXlzLmVudGl0eU1hcEtleV0gfSxcbiAgICBpZHM6IFsuLi5zdGF0ZVtzdGF0ZUtleXMuaWRzS2V5XV0sXG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRFbnRpdHlVcGRhdGVyUmVzdWx0KFxuICBzdGF0ZTogRW50aXR5U3RhdGU8YW55PixcbiAgc3RhdGVLZXlzOiB7XG4gICAgZW50aXR5TWFwS2V5OiBzdHJpbmc7XG4gICAgaWRzS2V5OiBzdHJpbmc7XG4gIH0sXG4gIGRpZE11dGF0ZTogRGlkTXV0YXRlXG4pOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgc3dpdGNoIChkaWRNdXRhdGUpIHtcbiAgICBjYXNlIERpZE11dGF0ZS5Cb3RoOiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBbc3RhdGVLZXlzLmVudGl0eU1hcEtleV06IHN0YXRlLmVudGl0eU1hcCxcbiAgICAgICAgW3N0YXRlS2V5cy5pZHNLZXldOiBzdGF0ZS5pZHMsXG4gICAgICB9O1xuICAgIH1cbiAgICBjYXNlIERpZE11dGF0ZS5FbnRpdGllczoge1xuICAgICAgcmV0dXJuIHsgW3N0YXRlS2V5cy5lbnRpdHlNYXBLZXldOiBzdGF0ZS5lbnRpdHlNYXAgfTtcbiAgICB9XG4gICAgZGVmYXVsdDoge1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYWRkRW50aXR5TXV0YWJseShcbiAgc3RhdGU6IEVudGl0eVN0YXRlPGFueT4sXG4gIGVudGl0eTogYW55LFxuICBzZWxlY3RJZDogU2VsZWN0RW50aXR5SWQ8YW55PlxuKTogRGlkTXV0YXRlIHtcbiAgY29uc3QgaWQgPSBzZWxlY3RJZChlbnRpdHkpO1xuXG4gIGlmIChzdGF0ZS5lbnRpdHlNYXBbaWRdKSB7XG4gICAgcmV0dXJuIERpZE11dGF0ZS5Ob25lO1xuICB9XG5cbiAgc3RhdGUuZW50aXR5TWFwW2lkXSA9IGVudGl0eTtcbiAgc3RhdGUuaWRzLnB1c2goaWQpO1xuXG4gIHJldHVybiBEaWRNdXRhdGUuQm90aDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFkZEVudGl0aWVzTXV0YWJseShcbiAgc3RhdGU6IEVudGl0eVN0YXRlPGFueT4sXG4gIGVudGl0aWVzOiBhbnlbXSxcbiAgc2VsZWN0SWQ6IFNlbGVjdEVudGl0eUlkPGFueT5cbik6IERpZE11dGF0ZSB7XG4gIGxldCBkaWRNdXRhdGUgPSBEaWRNdXRhdGUuTm9uZTtcblxuICBmb3IgKGNvbnN0IGVudGl0eSBvZiBlbnRpdGllcykge1xuICAgIGNvbnN0IHJlc3VsdCA9IGFkZEVudGl0eU11dGFibHkoc3RhdGUsIGVudGl0eSwgc2VsZWN0SWQpO1xuXG4gICAgaWYgKHJlc3VsdCA9PT0gRGlkTXV0YXRlLkJvdGgpIHtcbiAgICAgIGRpZE11dGF0ZSA9IHJlc3VsdDtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gZGlkTXV0YXRlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0RW50aXR5TXV0YWJseShcbiAgc3RhdGU6IEVudGl0eVN0YXRlPGFueT4sXG4gIGVudGl0eTogYW55LFxuICBzZWxlY3RJZDogU2VsZWN0RW50aXR5SWQ8YW55PlxuKTogRGlkTXV0YXRlIHtcbiAgY29uc3QgaWQgPSBzZWxlY3RJZChlbnRpdHkpO1xuXG4gIGlmIChzdGF0ZS5lbnRpdHlNYXBbaWRdKSB7XG4gICAgc3RhdGUuZW50aXR5TWFwW2lkXSA9IGVudGl0eTtcbiAgICByZXR1cm4gRGlkTXV0YXRlLkVudGl0aWVzO1xuICB9XG5cbiAgc3RhdGUuZW50aXR5TWFwW2lkXSA9IGVudGl0eTtcbiAgc3RhdGUuaWRzLnB1c2goaWQpO1xuXG4gIHJldHVybiBEaWRNdXRhdGUuQm90aDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldEVudGl0aWVzTXV0YWJseShcbiAgc3RhdGU6IEVudGl0eVN0YXRlPGFueT4sXG4gIGVudGl0aWVzOiBhbnlbXSxcbiAgc2VsZWN0SWQ6IFNlbGVjdEVudGl0eUlkPGFueT5cbik6IERpZE11dGF0ZSB7XG4gIGxldCBkaWRNdXRhdGUgPSBEaWRNdXRhdGUuTm9uZTtcblxuICBmb3IgKGNvbnN0IGVudGl0eSBvZiBlbnRpdGllcykge1xuICAgIGNvbnN0IHJlc3VsdCA9IHNldEVudGl0eU11dGFibHkoc3RhdGUsIGVudGl0eSwgc2VsZWN0SWQpO1xuXG4gICAgaWYgKGRpZE11dGF0ZSA9PT0gRGlkTXV0YXRlLkJvdGgpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGRpZE11dGF0ZSA9IHJlc3VsdDtcbiAgfVxuXG4gIHJldHVybiBkaWRNdXRhdGU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW1vdmVFbnRpdGllc011dGFibHkoXG4gIHN0YXRlOiBFbnRpdHlTdGF0ZTxhbnk+LFxuICBpZHNPclByZWRpY2F0ZTogRW50aXR5SWRbXSB8IEVudGl0eVByZWRpY2F0ZTxhbnk+XG4pOiBEaWRNdXRhdGUge1xuICBjb25zdCBpZHMgPSBBcnJheS5pc0FycmF5KGlkc09yUHJlZGljYXRlKVxuICAgID8gaWRzT3JQcmVkaWNhdGVcbiAgICA6IHN0YXRlLmlkcy5maWx0ZXIoKGlkKSA9PiBpZHNPclByZWRpY2F0ZShzdGF0ZS5lbnRpdHlNYXBbaWRdKSk7XG4gIGxldCBkaWRNdXRhdGUgPSBEaWRNdXRhdGUuTm9uZTtcblxuICBmb3IgKGNvbnN0IGlkIG9mIGlkcykge1xuICAgIGlmIChzdGF0ZS5lbnRpdHlNYXBbaWRdKSB7XG4gICAgICBkZWxldGUgc3RhdGUuZW50aXR5TWFwW2lkXTtcbiAgICAgIGRpZE11dGF0ZSA9IERpZE11dGF0ZS5Cb3RoO1xuICAgIH1cbiAgfVxuXG4gIGlmIChkaWRNdXRhdGUgPT09IERpZE11dGF0ZS5Cb3RoKSB7XG4gICAgc3RhdGUuaWRzID0gc3RhdGUuaWRzLmZpbHRlcigoaWQpID0+IGlkIGluIHN0YXRlLmVudGl0eU1hcCk7XG4gIH1cblxuICByZXR1cm4gZGlkTXV0YXRlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdXBkYXRlRW50aXRpZXNNdXRhYmx5KFxuICBzdGF0ZTogRW50aXR5U3RhdGU8YW55PixcbiAgaWRzT3JQcmVkaWNhdGU6IEVudGl0eUlkW10gfCBFbnRpdHlQcmVkaWNhdGU8YW55PixcbiAgY2hhbmdlczogRW50aXR5Q2hhbmdlczxhbnk+LFxuICBzZWxlY3RJZDogU2VsZWN0RW50aXR5SWQ8YW55PlxuKTogRGlkTXV0YXRlIHtcbiAgY29uc3QgaWRzID0gQXJyYXkuaXNBcnJheShpZHNPclByZWRpY2F0ZSlcbiAgICA/IGlkc09yUHJlZGljYXRlXG4gICAgOiBzdGF0ZS5pZHMuZmlsdGVyKChpZCkgPT4gaWRzT3JQcmVkaWNhdGUoc3RhdGUuZW50aXR5TWFwW2lkXSkpO1xuICBsZXQgbmV3SWRzOiBSZWNvcmQ8RW50aXR5SWQsIEVudGl0eUlkPiB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbiAgbGV0IGRpZE11dGF0ZSA9IERpZE11dGF0ZS5Ob25lO1xuXG4gIGZvciAoY29uc3QgaWQgb2YgaWRzKSB7XG4gICAgY29uc3QgZW50aXR5ID0gc3RhdGUuZW50aXR5TWFwW2lkXTtcblxuICAgIGlmIChlbnRpdHkpIHtcbiAgICAgIGNvbnN0IGNoYW5nZXNSZWNvcmQgPVxuICAgICAgICB0eXBlb2YgY2hhbmdlcyA9PT0gJ2Z1bmN0aW9uJyA/IGNoYW5nZXMoZW50aXR5KSA6IGNoYW5nZXM7XG4gICAgICBzdGF0ZS5lbnRpdHlNYXBbaWRdID0geyAuLi5lbnRpdHksIC4uLmNoYW5nZXNSZWNvcmQgfTtcbiAgICAgIGRpZE11dGF0ZSA9IERpZE11dGF0ZS5FbnRpdGllcztcblxuICAgICAgY29uc3QgbmV3SWQgPSBzZWxlY3RJZChzdGF0ZS5lbnRpdHlNYXBbaWRdKTtcbiAgICAgIGlmIChuZXdJZCAhPT0gaWQpIHtcbiAgICAgICAgc3RhdGUuZW50aXR5TWFwW25ld0lkXSA9IHN0YXRlLmVudGl0eU1hcFtpZF07XG4gICAgICAgIGRlbGV0ZSBzdGF0ZS5lbnRpdHlNYXBbaWRdO1xuXG4gICAgICAgIG5ld0lkcyA9IG5ld0lkcyB8fCB7fTtcbiAgICAgICAgbmV3SWRzW2lkXSA9IG5ld0lkO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChuZXdJZHMpIHtcbiAgICBzdGF0ZS5pZHMgPSBzdGF0ZS5pZHMubWFwKChpZCkgPT4gbmV3SWRzW2lkXSA/PyBpZCk7XG4gICAgZGlkTXV0YXRlID0gRGlkTXV0YXRlLkJvdGg7XG4gIH1cblxuICBpZiAobmdEZXZNb2RlICYmIHN0YXRlLmlkcy5sZW5ndGggIT09IE9iamVjdC5rZXlzKHN0YXRlLmVudGl0eU1hcCkubGVuZ3RoKSB7XG4gICAgY29uc29sZS53YXJuKFxuICAgICAgJ0BuZ3J4L3NpZ25hbHMvZW50aXRpZXM6IEVudGl0aWVzIHdpdGggSURzOicsXG4gICAgICBpZHMsXG4gICAgICAnYXJlIG5vdCB1cGRhdGVkIGNvcnJlY3RseS4nLFxuICAgICAgJ01ha2Ugc3VyZSB0byBhcHBseSB2YWxpZCBjaGFuZ2VzIHdoZW4gdXNpbmcgYHVwZGF0ZUVudGl0eWAsJyxcbiAgICAgICdgdXBkYXRlRW50aXRpZXNgLCBhbmQgYHVwZGF0ZUFsbEVudGl0aWVzYCB1cGRhdGVycy4nXG4gICAgKTtcbiAgfVxuXG4gIHJldHVybiBkaWRNdXRhdGU7XG59XG4iXX0=